<project default="main">

	<!-- Steps Ant properties available at runtime: - eclipse.pdebuild.scripts: 
		the org.eclipse.eclipse.pdebuild.scripts folder - eclipse.pdebuild.home: 
		the root folder of pde build - eclipse.pdebuild.templates: the templates 
		folder -->

	<!--build monitoring information: e-mail, smtp server, build label -->
	<property file="monitor.properties" />

	<!--location of PDE Build configuration files for builder and packager -->
	<property name="eclipse.build.configs" value="${basedir}/eclipse/buildConfigs" />

	<property name="base.builder" value="${basedir}/../org.eclipse.releng.basebuilder" />

	<!--location of properties file containing last tag used for integration 
		build -->
	<property name="mapTag.properties"
		value="/home/users/releng/buildTools/eclipse33/mapTag.properties" />


	<!--default buildDirectory -->
	<property name="buildDirectory" value="${basedir}/../src" />

	<!--default location for build output, parent to ${buildId} -->
	<property name="postingDirectory" value="${buildDirectory}" />

	<!--remote sign machine login infomation -->
	<property name="username.sign" value="" />
	<property name="password.sign" value="" />
	<property name="hostname.sign" value="" />
	<property name="home.dir" value="" />
	<property name="sign.dir" value="" />

	<target name="main" depends="init">
		<antcall target="prepareMapFile" />
		<antcall target="prepareSrc" />
		<antcall target="buildBirtFeature" />
		<antcall target="buildBirtOSGI" />
		<antcall target="buildBirtChartOSGI" />
		<antcall target="fetchBirtWtpFeature" />
		<antcall target="buildBirtTestFeature" />
		<antcall target="fetchRCP" />
		<antcall target="buildBirtRCPFeature" />
		<antcall target="unpackUpdateJarsForPackaging" />
		<antcall target="buildBirtWebViewer" />
		<antcall target="BuildChartViewer" />
		<antcall target="CreateDistribute" />

		<antcall target="buildBirtNLFeature" />
		<antcall target="iPortalSetup" />
		<antcall target="buildBirtWtpFeature" />

		<antcall target="verifyCompile" />
		<antcall target="CreateUpdateSite" />

		<parallel failonany="true">
			<sequential>
				<antcall target="runBirtTest" />
			</sequential>
			<sequential>
				<antcall target="generateJavaCrossReference" />
				<antcall target="generateDocumentCheck" />
				<antcall target="generateJavaDoc" />
			</sequential>
		</parallel>
                <antcall target="logger">
                        <param name="message" value="Build Successful" />
                </antcall>
	</target>

	<target name="init">

		<ant antfile="build.xml" target="init" />

		<property file="${buildDirectory}/label.properties" />

		<condition property="fetchTag" value="CVS=HEAD,GIT=${mapVersionTag}">
			<equals arg1="${buildType}" arg2="N" />
		</condition>
		<condition property="forceContextQualifier" value="${buildId}">
			<equals arg1="${buildType}" arg2="N" />
		</condition>
		<condition property="generateFeatureVersionSuffix" value="false">
			<equals arg1="${buildType}" arg2="N" />
		</condition>
		<!-- <condition property="createUpdateSite" value="true"> <equals arg1="${buildType}" 
			arg2="I" /> </condition> -->
		<!-- concise build setting -->

		<condition property="skip.build.OSGI" value="true">
			<equals arg1="${HQ.BIRT.skip}" arg2="true" />
		</condition>
		<condition property="skip.build.WTP" value="true">
			<equals arg1="${HQ.BIRT.skip}" arg2="true" />
		</condition>
		<condition property="skip.build.testsuite" value="true">
			<equals arg1="${HQ.BIRT.skip}" arg2="true" />
		</condition>
		<condition property="skip.unit.test" value="true">
			<equals arg1="${HQ.BIRT.skip}" arg2="true" />
		</condition>
		<condition property="skip.allinone.linux" value="true">
			<equals arg1="${HQ.BIRT.skip}" arg2="true" />
		</condition>
		<condition property="prepare.src.flag" value="true">
			<equals arg1="${HQ.BIRT.skip}" arg2="true" />
		</condition>

		<condition property="skip.build.rcp" value="true">
			<equals arg1="${HQ.BIRT.skip}" arg2="true" />
		</condition>

		<condition property="update.batik" value="true">
			<equals arg1="${HQ.BIRT.skip}" arg2="true" />
		</condition>

		<condition property="repackage.allinone" value="true">
			<equals arg1="${HQ.BIRT.skip}" arg2="true" />
		</condition>

		<condition property="build.runtimeOSGI" value="true">
			<equals arg1="${HQ.BIRT.skip}" arg2="true" />
		</condition>

		<!--compiler args -->
		<property name="compilerArg"
			value="-enableJavadoc -encoding utf-8 -warn:-discouraged,forbidden" />
		<property name="javacSource" value="1.6" />
		<property name="javacTarget" value="1.6" />
		<property name="javacDebugInfo" value="true" />
		<property name="javacFailOnError" value="false" />
		<property name="javacVerbose" value="true" />
		<property name="logExtension" value=".xml" />
		<!--this property required as of Eclipse 3.0 stream builds > 20031126 -->
		<property name="buildingOSGi" value="true" />
		<!--zip args -->
		<property name="zipargs" value="-y -qq" />
		<!--unzip args -->
		<property name="unzipArgs" value="-qq" />
	</target>

	<target name="buildBirtFeature">
		<antcall target="logger">
			<param name="message" value="BIRT sdk feature build started" />
		</antcall>

		<ant antfile="build.xml" dir="${basedir}">
			<property name="component" value="${eclipse.build.configs}/birt" />
		</ant>

		<antcall target="logger">
			<param name="message" value="BIRT sdk feature build finished" />
		</antcall>
	</target>

	<target name="buildBirtOSGI" unless="skip.build.OSGI">
		<antcall target="logger">
			<param name="message" value="BIRT OSGI sdk feature build started" />
		</antcall>
		<ant antfile="build.xml" dir="${basedir}">
			<property name="component" value="${eclipse.build.configs}/birt.osgi" />
		</ant>
		<antcall target="logger">
			<param name="message" value="BIRT OSGI sdk feature build finished" />
		</antcall>
	</target>

	<target name="buildBirtChartOSGI" unless="skip.build.OSGI">
		<antcall target="logger">
			<param name="message" value="BIRT Chart OSGI sdk feature build started" />
		</antcall>
		<ant antfile="build.xml" dir="${basedir}">
			<property name="component" value="${eclipse.build.configs}/birt.chart.osgi" />
		</ant>
		<antcall target="logger">
			<param name="message" value="BIRT Chart OSGI sdk feature build finished" />
		</antcall>
	</target>

	<target name="CreateDistribute">
		<antcall target="logger">
			<param name="message" value="Packaging started" />
		</antcall>

		<mkdir dir="${postingDirectory}/${buildId}" />

		<!-- generate genReport.sh/.bat for birt-runtime-package -->
		<property name="template.dir" value="${baseLocation}/../PackageFiles/template" />
		<delete>
			<fileset dir="${template.dir}/engine.runtime.bin">
				<include name="*.*" />
			</fileset>
		</delete>

		<!-- prepare non-osgi runtime jars -->
		<ant antfile="BIRTDownloadSetup.xml" dir="${eclipse.build.configs}/birt/tools"
			target="createBirtRuntimeNonOSGi">
			<property name="OutputDir" value="${postingDirectory}/${buildId}" />
			<property name="deposit" value="${buildDirectory}/${buildId}" />
		</ant>

		<property file="${buildDirectory}/finalPluginsVersions.properties" />

		<!-- copy runtime to ${buildDirectory}/${buildId}/eclipse/plugins/org.eclipse.birt.integration.wtp_${org.eclipse.birt.integration.wtp}/runtime -->
		<ant antfile="BIRTDownloadSetup.xml" dir="${eclipse.build.configs}/birt/tools"
			target="createWebViewerExample">
			<property name="OutputDir"
				value="${buildDirectory}/plugins/org.eclipse.birt.integration.wtp.ui/runtime" />
			<property name="deposit" value="${buildDirectory}/${buildId}" />
		</ant>


		<!-- copy chart runtime to ${buildDirectory}/${buildId}/eclipse/plugins/org.eclipse.birt.chart.integration.wtp.ui_${org.eclipse.birt.chart.integration.wtp.ui}/runtime -->
		<ant antfile="BIRTDownloadSetup.xml" dir="${eclipse.build.configs}/birt/tools"
			target="createChartViewer">
			<property name="runtime.tmp"
				value="${buildDirectory}/plugins/org.eclipse.birt.chart.integration.wtp.ui/runtime" />
		</ant>


		<!-- fix bugzilla bug 225500 -->

		<property name="temp.dir"
			value="${buildDirectory}/plugins/org.eclipse.birt.chart.integration.wtp.ui/runtime" />
		<mkdir dir="${temp.dir}/chart-viewer-sample" />
		<exec executable="unzip" dir="${temp.dir}/">
			<arg line="-q chart-viewer-sample.war -d ${temp.dir}/chart-viewer-sample" />
		</exec>

		<delete file="${temp.dir}/chart-viewer-sample.war" failonerror="false" />
		<delete file="${temp.dir}/chart-viewer-sample/WEB-INF/web.xml"
			failonerror="false" />

		<zip destfile="${temp.dir}/chart.zip">
			<zipfileset dir="${temp.dir}/chart-viewer-sample"
				includes="**/*" />
		</zip>

		<delete dir="${temp.dir}/chart-viewer-sample" failonerror="false" />

		<!-- create AllInOne,AllInOne for Linux, RCP, FrameworkSDK,Framework,Chart,BIRTSample,TestSuite,Database -->
		<ant antfile="BIRTDownloadSetup.xml" dir="${eclipse.build.configs}/birt/tools"
			target="default">
			<property name="OutputDir" value="${postingDirectory}/${buildId}" />
			<property name="deposit" value="${buildDirectory}/${buildId}" />
		</ant>

		<antcall target="logger">
			<param name="message" value="Packaging finished" />
		</antcall>

	</target>

	<target name="sendNotification" unless="nomail">
		<!-- copy directory.txt to output directory -->
		<copy tofile="${postingDirectory}/${buildId}/directory.txt" file="${buildDirectory}/directory.txt" />
		<copy tofile="${postingDirectory}/monitor.properties" file="monitor.properties"
			overwrite="true" />
		<copy tofile="${postingDirectory}/finalPluginsVersions.properties"
			file="${buildDirectory}/finalPluginsVersions.properties" overwrite="true" />
		<copy tofile="${postingDirectory}/finalFeaturesVersions.properties"
			file="${buildDirectory}/finalFeaturesVersions.properties" overwrite="true" />
		<!--copy build and update dtp log to output directory -->
		<copy todir="${postingDirectory}/${buildId}">
			<fileset dir="." includes="*.log" />
		</copy>
		<!-- Send build ready mail to QA -->
		<ant antfile="${eclipse.build.configs}/../helper.xml" target="InformQA" />
	</target>

	<target name="iPortalSetup" unless="skip.build.NL">
		<ant antfile="BIRTDownloadSetup.xml" dir="${eclipse.build.configs}/birt/tools"
			target="createIpotalLib">
			<property name="OutputDir" value="${postingDirectory}/${buildId}" />
			<property name="deposit" value="${buildDirectory}/${buildId}" />
		</ant>
	</target>

	<target name="renameBirtPackage" unless="skip.rename.package">
		<move
			file="${postingDirectory}/${buildId}/birt-charts-${package.version}.zip"
			tofile="${postingDirectory}/${buildId}/birt-charts-${package.version}-${build.date}.zip" />
		<move
			file="${postingDirectory}/${buildId}/birt-database-${package.version}.zip"
			tofile="${postingDirectory}/${buildId}/birt-database-${package.version}-${build.date}.zip" />
		<move
			file="${postingDirectory}/${buildId}/birt-rcp-report-designer-${package.version}.zip"
			tofile="${postingDirectory}/${buildId}/birt-rcp-report-designer-${package.version}-${build.date}.zip" />
		<move
			file="${postingDirectory}/${buildId}/birt-report-designer-all-in-one-${package.version}.zip"
			tofile="${postingDirectory}/${buildId}/birt-report-designer-all-in-one-${package.version}-${build.date}.zip" />
		<move
			file="${postingDirectory}/${buildId}/birt-report-designer-all-in-one-x86_64-${package.version}.zip"
			tofile="${postingDirectory}/${buildId}/birt-report-designer-all-in-one-x86_64-${package.version}-${build.date}.zip" />	
		<move
			file="${postingDirectory}/${buildId}/birt-report-designer-all-in-one-${package.version}-linux-gtk.tar.gz"
			tofile="${postingDirectory}/${buildId}/birt-report-designer-all-in-one-${package.version}-${build.date}-linux-gtk.tar.gz" />
		<move
			file="${postingDirectory}/${buildId}/birt-report-designer-all-in-one-${package.version}-macosx-cocoa.tar.gz"
			tofile="${postingDirectory}/${buildId}/birt-report-designer-all-in-one-${package.version}-${build.date}-macosx-cocoa.tar.gz" />
		<move
			file="${postingDirectory}/${buildId}/birt-report-framework-${package.version}.zip"
			tofile="${postingDirectory}/${buildId}/birt-report-framework-${package.version}-${build.date}.zip" />
		<move
			file="${postingDirectory}/${buildId}/birt-report-framework-sdk-${package.version}.zip"
			tofile="${postingDirectory}/${buildId}/birt-report-framework-sdk-${package.version}-${build.date}.zip" />
		<move
			file="${postingDirectory}/${buildId}/birt-runtime-${package.version}.zip"
			tofile="${postingDirectory}/${buildId}/birt-runtime-${package.version}-${build.date}.zip" />
		<move
			file="${postingDirectory}/${buildId}/birt-sample-plugins-${package.version}.zip"
			tofile="${postingDirectory}/${buildId}/birt-sample-plugins-${package.version}-${build.date}.zip" />
		<move
			file="${postingDirectory}/${buildId}/birt-source-${package.version}.zip"
			tofile="${postingDirectory}/${buildId}/birt-source-${package.version}-${build.date}.zip" />
		<move
			file="${postingDirectory}/${buildId}/birt-tests-suite-${package.version}.zip"
			tofile="${postingDirectory}/${buildId}/birt-tests-suite-${package.version}-${build.date}.zip" />
		<move
			file="${postingDirectory}/${buildId}/birt-wtp-integration-sdk-${package.version}.zip"
			tofile="${postingDirectory}/${buildId}/birt-wtp-integration-sdk-${package.version}-${build.date}.zip" />

		<antcall target="renameOSGIruntimePackage" />

		<antcall target="renameNLPackage" />

		<antcall target="removeBirtAllForNightly" />

	</target>

	<target name="renameOSGIruntimePackage" if="build.runtimeOSGI">
		<move
			file="${postingDirectory}/${buildId}/birt-runtime-osgi-${package.version}.zip"
			tofile="${postingDirectory}/${buildId}/birt-runtime-osgi-${package.version}-${build.date}.zip" />
	</target>

	<target name="renameNLPackage" unless="skip.build.NL">
		<move
			file="${postingDirectory}/${buildId}/NLpack1_FeatureOverlay-birt-charts-${package.version}.zip"
			tofile="${postingDirectory}/${buildId}/NLpack1_FeatureOverlay-birt-charts-${package.version}-${build.date}.zip" />
		<move
			file="${postingDirectory}/${buildId}/NLpack1_FeatureOverlay-birt-rcp-report-designer-${package.version}.zip"
			tofile="${postingDirectory}/${buildId}/NLpack1_FeatureOverlay-birt-rcp-report-designer-${package.version}-${build.date}.zip" />
		<move
			file="${postingDirectory}/${buildId}/NLpack1_FeatureOverlay-birt-report-all-in-one-${package.version}.zip"
			tofile="${postingDirectory}/${buildId}/NLpack1_FeatureOverlay-birt-report-all-in-one-${package.version}-${build.date}.zip" />
		<move
			file="${postingDirectory}/${buildId}/NLpack1_FeatureOverlay-birt-report-framework-${package.version}.zip"
			tofile="${postingDirectory}/${buildId}/NLpack1_FeatureOverlay-birt-report-framework-${package.version}-${build.date}.zip" />
		<move
			file="${postingDirectory}/${buildId}/NLpack1-birt-charts-${package.version}.zip"
			tofile="${postingDirectory}/${buildId}/NLpack1-birt-charts-${package.version}-${build.date}.zip" />
		<move
			file="${postingDirectory}/${buildId}/NLpack1-birt-rcp-report-designer-${package.version}.zip"
			tofile="${postingDirectory}/${buildId}/NLpack1-birt-rcp-report-designer-${package.version}-${build.date}.zip" />
		<move
			file="${postingDirectory}/${buildId}/NLpack1-birt-report-designer-all-in-one-${package.version}.zip"
			tofile="${postingDirectory}/${buildId}/NLpack1-birt-report-designer-all-in-one-${package.version}-${build.date}.zip" />
		<move
			file="${postingDirectory}/${buildId}/NLpack1-birt-report-framework-${package.version}.zip"
			tofile="${postingDirectory}/${buildId}/NLpack1-birt-report-framework-${package.version}-${build.date}.zip" />
		<move
			file="${postingDirectory}/${buildId}/NLpack1-birt-runtime-${package.version}.zip"
			tofile="${postingDirectory}/${buildId}/NLpack1-birt-runtime-${package.version}-${build.date}.zip" />
	</target>

	<target name="installWTPpackage" unless="HQ.BIRT.skip">
		<property name="updateJarWorkingDir" value="${buildDirectory}/updateJars" />
		<unzip
			src="${buildDirectory}/${buildId}/birt-wtp-integration-sdk-${package.version}.zip"
			dest="${updateJarWorkingDir}" overwrite="true" />
	</target>

	<target name="CreateUpdateSite" if="updateSite">

		<property name="updateJarWorkingDir" value="${buildDirectory}/updateJars" />
		<property name="compsite.site" value="${updateSite}" />
		<property name="repo" value="${updateSite}/${buildId}" />

		<mkdir dir="${updateJarWorkingDir}" />
		<mkdir dir="${updateJarWorkingDir}/site" />
		<mkdir dir="${updateJarWorkingDir}/packed" />

		<unzip src="${buildDirectory}/birt-all-${package.version}.bak.zip"
			dest="${updateJarWorkingDir}" overwrite="true" />

		<antcall target="installWTPpackage" />

		<unzip src="${buildDirectory}/${buildId}/birt-nl-${package.version}.zip"
			dest="${updateJarWorkingDir}" overwrite="true" />

		<unzip
			src="${buildDirectory}/${buildId}/birt-dtp-nl-${package.version}.zip"
			dest="${updateJarWorkingDir}" overwrite="true" />

		<delete includeemptydirs="true">
			<fileset dir="${updateJarWorkingDir}/eclipse/features">
				<include name="org.eclipse.birt.sdk*/**" />
				<include name="org.eclipse.birt.integration.wtp.sdk*/**" />
				<include name="com.lowagie.itext*/**" />
				<include name="org.apache.commons.codec*/**" />
				<include name="org.apache.derby.core*/**" />
				<include name="org.eclipse.birt.chart.runtime*/**" />
				<include name="org.eclipse.birt.crosstab*/**" />
				<include name="org.eclipse.birt.report.data.oda.jdbc.dbprofile*/**" />
				<include name="org.eclipse.birt.report.designer.debug*/**" />
				<include name="org.eclipse.birt.report.designer_*/**" />
				<include name="org.eclipse.birt.report.designer.source_*/**" />
				<include name="org.eclipse.birt.report.runtime_*/**" />
				<include name="org.eclipse.birt.report.runtime.source_*/**" />
				<include name="org.eclipse.birt.thirdparty*/**" />
				<include name="org.mozilla.rhino*/**" />
				<include name="org.w3c.sac*/**" />
			</fileset>
			<fileset dir="${updateJarWorkingDir}/eclipse/plugins">
				<include name="*.thirdparty*/**" />
				<include name="org.eclipse.birt.chart.runtime_*.jar" />
				<include name="org.eclipse.birt.chart.runtime.source_*.jar" />
				<include name="org.eclipse.birt.report.runtime_*.jar" />
				<include name="org.eclipse.birt.report.runtime.source_*.jar" />
				<include name="org.eclipse.birt.report.designer_*.jar" />
				<include name="org.eclipse.birt.report.designer.source_*.jar" />
			</fileset>
		</delete>

		<copy todir="${updateJarWorkingDir}/packed">
			<fileset dir="${updateJarWorkingDir}/eclipse">
				<include name="*/**" />
			</fileset>
		</copy>

		<!-- create site.xml -->
		<antcall target="generateCategory" />

		<!-- generate p2 composite update site, generate p2-metadata -->
		<antcall target="GenP2CompositeUpdateSite" />

		<!-- generate birt-updatesite package -->
		<antcall target="GenUpdatesitePackage" />
		<antcall target="GenUpdatesitePackageForHQ" />

	</target>

	<target name="generatePack200" unless="HQ.BIRT.skip">
		<property name="p2.repo.name" value="BIRT TEST" />
		<mkdir dir="${repo}" />

		<replace file="${eclipse.build.configs}/../../extras/pack200"
			token="@pack200@" value="${jvm15_home}/bin/pack200" />
		<chmod file="${eclipse.build.configs}/../../extras/pack200"
			perm="755" />

		<exec executable="dos2unix" dir="${eclipse.build.configs}/../../extras">
			<arg line=" pack200" />
		</exec>

		<java
			jar="${basedir}/../org.eclipse.releng.basebuilder/plugins/org.eclipse.equinox.launcher.jar"
			fork="true" timeout="10800000" jvm="${jvm15_home}/bin/java"
			failonerror="true" maxmemory="512m" dir="${updateJarWorkingDir}">
			<jvmarg
				value="-Dorg.eclipse.update.jarprocessor.pack200=${eclipse.build.configs}/../../extras" />
			<arg line="-application org.eclipse.update.core.siteOptimizer -verbose" />
			<arg
				line="-jarProcessor -outputDir ${updateJarWorkingDir}/site -processAll -pack eclipse" />
		</java>

		<copy todir="${updateJarWorkingDir}/packed" overwrite="true">
			<fileset dir="${updateJarWorkingDir}/site">
				<include name="*/**" />
			</fileset>
		</copy>

	</target>

	<target name="GenP2CompositeUpdateSite" unless="HQ.BIRT.skip">
		<property name="p2.repo.name" value="BIRT TEST" />
		<mkdir dir="${repo}" />

		<!-- generate pack200 -->
		<antcall target="generatePack200" />

		<copy file="${updateJarWorkingDir}/packed/site.xml" todir="${repo}" />

		<java
			jar="${basedir}/../org.eclipse.releng.basebuilder/plugins/org.eclipse.equinox.launcher.jar"
			fork="true" timeout="10800000" jvm="${jvm15_home}/bin/java"
			failonerror="true" maxmemory="512m">
			<arg
				line="-application org.eclipse.equinox.p2.publisher.UpdateSitePublisher" />
			<arg line="-metadataRepository file:${repo}" />
			<arg line="-artifactRepository file:${repo}" />
			<arg line="-source ${updateJarWorkingDir}/packed" />
			<arg line="-configs ${updateSiteConfig}" />
			<arg line="-compress" />
			<arg line="-reusePack200Files" />
			<arg line="-publishArtifacts" />
		</java>

		<copy todir="${repo}/features">
			<fileset dir="${updateJarWorkingDir}/packed/features"
				includes="*.pack.gz" />
		</copy>

		<!--try create composite repository -->
		<p2.composite.artifact.repository.create
			location="file://${compsite.site}" name="${p2.repo.name}" compressed="true"
			failOnExists="false" />
		<p2.composite.metadata.repository.create
			location="file://${compsite.site}" name="${p2.repo.name}" compressed="true"
			failOnExists="false" />

		<!--add childRepo to composite repo -->
		<p2.composite.artifact.repository.add
			location="file://${compsite.site}" child="${buildId}" />
		<p2.composite.metadata.repository.add
			location="file://${compsite.site}" child="${buildId}" />

	</target>

	<target name="generateCategory">

		<property name="updateJarWorkingDir" value="${buildDirectory}/updateJars" />
		<!-- generate site.xml -->
		<property file="${buildDirectory}/finalFeaturesVersions.properties" />
		<copy file="${eclipse.build.configs}/../../extras/site.xml"
			tofile="${updateJarWorkingDir}/packed/site.xml" />
		<!-- replace the feature version in site.xml -->
		<replace file="${updateJarWorkingDir}/packed/site.xml" value="${org.eclipse.birt.cshelp}"
			token="@FEATURE.BIRT.CSHELP@" />
		<replace file="${updateJarWorkingDir}/packed/site.xml" value="${org.eclipse.birt.example}"
			token="@FEATURE.BIRT.EXAMPLE@" />
		<replace file="${updateJarWorkingDir}/packed/site.xml" value="${org.eclipse.birt.doc.isv}"
			token="@FEATURE.BIRT.DOC.ISV@" />
		<replace file="${updateJarWorkingDir}/packed/site.xml" value="${org.eclipse.birt.source}"
			token="@FEATURE.BIRT.SOURCE@" />
		<replace file="${updateJarWorkingDir}/packed/site.xml" value="${org.eclipse.birt}"
			token="@FEATURE.BIRT@" />
		<replace file="${updateJarWorkingDir}/packed/site.xml" value="${org.eclipse.birt.chart}"
			token="@FEATURE.CHART@" />
		<replace file="${updateJarWorkingDir}/packed/site.xml" value="${org.eclipse.birt.doc}"
			token="@FEATURE.BIRT.DOC@" />
		<replace file="${updateJarWorkingDir}/packed/site.xml" value="${org.eclipse.birt.chart.cshelp}"
			token="@FEATURE.CHART.CSHELP@" />
		<replace file="${updateJarWorkingDir}/packed/site.xml" value="${org.eclipse.birt.chart.doc.isv}"
			token="@FEATURE.CHART.DOC.ISV@" />
		<replace file="${updateJarWorkingDir}/packed/site.xml" value="${org.eclipse.birt.chart.source}"
			token="@FEATURE.CHART.SOURCE@" />
		<replace file="${updateJarWorkingDir}/packed/site.xml" value="${org.eclipse.birt.osgi.runtime.sdk}"
			token="@FEATURE.OSGI.RUNTIME.SDK@" />
		<replace file="${updateJarWorkingDir}/packed/site.xml" value="${org.eclipse.birt.chart.osgi.runtime.sdk}"
			token="@FEATURE.CHART.OSGI.RUNTIME.SDK@" />
		<replace file="${updateJarWorkingDir}/packed/site.xml" value="${org.eclipse.birt.chart.integration.wtp}"
			token="@FEATURE.CHART.WTP@" />
		<replace file="${updateJarWorkingDir}/packed/site.xml"
			value="${org.eclipse.birt.chart.integration.wtp.source}" token="@FEATURE.CHART.WTP.SOURCE@" />
		<replace file="${updateJarWorkingDir}/packed/site.xml" value="${org.eclipse.birt.integration.wtp}"
			token="@FEATURE.BIRT.WTP@" />
		<replace file="${updateJarWorkingDir}/packed/site.xml" value="${org.eclipse.birt.integration.wtp.source}"
			token="@FEATURE.BIRT.WTP.SOURCE@" />
	</target>

	<target name="GenUpdatesitePackage" unless="HQ.BIRT.skip">

		<zip
			destfile="${postingDirectory}/${buildId}/birt-updatesite-${package.version}.zip">
			<fileset dir="${repo}">
				<include name="features/**" />
				<include name="plugins/**" />
				<include name="artifacts.jar" />
				<include name="content.jar" />
			</fileset>
		</zip>

		<copy todir="${test.dir}/../../downloads/${package.version}"
			failonerror="false" overwrite="true">
			<fileset
				file="${postingDirectory}/${buildId}/birt-updatesite-${package.version}.zip" />
		</copy>

		<antcall target="renameBirtUpdatesitePackage" />

	</target>

	<target name="GenUpdatesitePackageForHQ" if="HQ.BIRT.skip">
		<zip
			destfile="${postingDirectory}/${buildId}/birt-updatesite-${package.version}.zip">
			<fileset dir="${updateJarWorkingDir}/packed">
				<include name="features/**" />
				<include name="plugins/**" />
			</fileset>
		</zip>

	</target>

	<target name="renameBirtUpdatesitePackage" unless="skip.rename.package">
		<move
			file="${postingDirectory}/${buildId}/birt-updatesite-${package.version}.zip"
			tofile="${postingDirectory}/${buildId}/birt-updatesite-${package.version}-${build.date}.zip" />
	</target>

	<target name="runBirtTest" unless="skip.unit.test">
		<ant antfile="${eclipse.build.configs}/../helper.xml" target="runBirtTest">
			<property name="runner.dir"
				value="${eclipse.build.configs}/birt.tests/test.scripts" />
		</ant>
		<ant antfile="${eclipse.build.configs}/../helper.xml" target="InformAutomation">
			<property name="runner.dir"
				value="${eclipse.build.configs}/birt.tests/test.scripts" />
		</ant>

		<ant antfile="${eclipse.build.configs}/../helper.xml" target="genTestResultSummary" />
	</target>

	<target name="runBirtPerformance">
		<ant antfile="${eclipse.build.configs}/../helper.xml" target="runBirtPerformance">
			<property name="runner.dir"
				value="${eclipse.build.configs}/birt.tests/test.scripts" />
		</ant>
		<ant antfile="${eclipse.build.configs}/../helper.xml" target="InformPerformance">
			<property name="runner.dir"
				value="${eclipse.build.configs}/birt.tests/test.scripts" />
		</ant>
	</target>

	<target name="checkLocal">
		<available property="mapsLocal" file="${buildDirectory}/maps/releng/maps" />
	</target>

	<target name="compareMapFiles" if="compareMaps">
		<property file="${mapTag.properties}" />
		<property name="cvsDiffFile" value="${buildDirectory}/cvsDiff.txt" />
		<cvs cvsRoot="${mapCvsRoot}" dest="${buildDirectory}/maps"
			command="diff -w -r ${lastMapTag}" output="${cvsDiffFile}" />
		<!--modifiedMaps mapDiffFile="${cvsDiffFile}" / -->
	</target>

	<target name="tagMapFiles" if="tagMaps">
		<!-- Stores tag on the filesystem so map files can be compared -->
		<echo file="${mapTag.properties}">
			lastMapTag=${buildId}
		</echo>
		<cvs dest="${buildDirectory}/maps/source/org.eclipse.birt.releng"
			command="tag v${package.version}_${buildId}" />
	</target>
	
	<target name="prepareMapFile" depends="checkLocal" unless="mapsLocal">

		<!-- github doesn't support archive command, we cannot do this.
		<exec executable="git" dir="${buildDirectory}/maps" output="${buildDirectory}/maps/maps.zip">
			<arg line="archive - -format=zip" />
			<arg line="- -remote=${mapGitRoot}/birt.git" />
			<arg line="${mapVersionTag} releng/maps" />
		</exec>
		<unzip src="${buildDirectory}/maps/maps.zip" dest="${buildDirectory}/maps" />
		-->
		
		<mkdir dir="${buildDirectory}/maps/releng/maps" />
		
		<!-- instead we simply copy the latest files from the cloned git repo -->
		<!-- please update the path if you changed the repo -->
		<echo>copy from: "${builder.dir}/gitClones/birt/releng/maps"</echo>
		<copy todir="${buildDirectory}/maps/releng/maps" overwrite="true" failonerror="false">
			<fileset dir="${builder.dir}/gitClones/birt/releng/maps" includes="**/*" />
		</copy>

		<!--compare the map files project -->
		<antcall target="compareMapFiles" />
		<!--tag the map files project -->
		<antcall target="tagMapFiles" />

		<!-- this value could be overwrite by the bootstrap command -->
		<property name="birt.url.token" value="@BIRT.URL.TOKEN@" />
		<property name="dtp.url.token" value="@DTP.URL.TOKEN@" />
		<property name="orbit.url.token" value="@ORBIT.URL.TOKEN@" />

		<property name="birt.url.newvalue" value="@BIRT.URL.NEWVALUE@" />
		<property name="dtp.url.newvalue" value="@DTP.URL.NEWVALUE@" />
		<property name="orbit.url.newvalue" value="@ORBIT.URL.NEWVALUE@" />

		<replace dir="${buildDirectory}/maps" value="${birt.url.newvalue}"
			token="${birt.url.token}">
			<include name="**/*.map" />
		</replace>
		<replace dir="${buildDirectory}/maps" value="${dtp.url.newvalue}"
			token="${dtp.url.token}">
			<include name="**/*.map" />
		</replace>
		<replace dir="${buildDirectory}/maps" value="${orbit.url.newvalue}"
			token="${orbit.url.token}">
			<include name="**/*.map" />
		</replace>

	</target>

	<target name="prepareSrc" if="prepare.src.flag">

		<antcall target="logger">
			<param name="message" value="Start to clone BIRT source" />
		</antcall>

		<delete failonerror="false">
			<fileset dir="${buildDirectory}/source">
				<include name="*/**" />
			</fileset>
		</delete>
		<mkdir dir="${buildDirectory}/source" />

		<!-- github doesn't support archive command, we cannot do this.
		<exec executable="git" dir="${buildDirectory}/source" output="${buildDirectory}/source/source.zip">
			<arg line="archive - -format=zip" />
			<arg line="- -remote=${mapGitRoot}/birt.git" />
			<arg line="${mapVersionTag}" />
		</exec>
		<unzip src="${buildDirectory}/source/source.zip" dest="${buildDirectory}/source" />
		-->
		
		<!-- instead we simply copy the latest files from the cloned git repo -->
		<!-- please update the path if you changed the repo -->
		<copy todir="${buildDirectory}/source" overwrite="true" failonerror="false">
			<fileset dir="${builder.dir}/gitClones/birt" includes="**/*" />
		</copy>

		<antcall target="logger">
			<param name="message" value="Finish to clone BIRT source" />
		</antcall>

		<copy todir="${buildDirectory}/plugins" overwrite="true"
			failonerror="false">
			<fileset dir="${buildDirectory}/source/build">
				<include name="org.eclipse.birt/**" />
				<include name="org.eclipse.birt.chart/**" />
				<include name="org.eclipse.birt.example/**" />
				<include name="org.eclipse.birt.sdk/**" />
			</fileset>
			<fileset dir="${buildDirectory}/source/chart" includes="**" />
			<fileset dir="${buildDirectory}/source/common" includes="**" />
			<fileset dir="${buildDirectory}/source/core" includes="**" />
			<fileset dir="${buildDirectory}/source/data" includes="**" />
			<fileset dir="${buildDirectory}/source/docs" includes="**" />
			<fileset dir="${buildDirectory}/source/engine" includes="**" />
			<fileset dir="${buildDirectory}/source/model" includes="**" />
			<fileset dir="${buildDirectory}/source/testsuites" includes="**" />
			<fileset dir="${buildDirectory}/source/UI" includes="**" />
			<fileset dir="${buildDirectory}/source/viewer" includes="**" />
			<fileset dir="${buildDirectory}/source/xtab" includes="**" />
		</copy>
		<!-- copy BIRT features and NL plugins -->
		<ant antfile="${eclipse.build.configs}/../../extras/prepareSrc.xml"
			target="prepareSrc" />

		<antcall target="logger">
			<param name="message"
				value="Copyied all source plugins to buildDirectory/plugins/" />
		</antcall>

	</target>

	<target name="buildBirtTestFeature" unless="skip.build.testsuite">
		<antcall target="logger">
			<param name="message" value="BIRT test feature build started" />
		</antcall>

		<ant antfile="build.xml" dir="${basedir}">
			<property name="component" value="${eclipse.build.configs}/birt.tests" />
		</ant>

		<antcall target="logger">
			<param name="message" value="BIRT test feature build finished" />
		</antcall>

	</target>

	<target name="buildBirtWtpFeature" unless="skip.build.WTP">
                <antcall target="logger">
                        <param name="message" value="BIRT wtp feature build started" />
                </antcall>
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="generate">
			<property name="builder" value="${eclipse.build.configs}/birt.wtp" />
		</ant>
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="process">
			<property name="builder" value="${eclipse.build.configs}/birt.wtp" />
		</ant>
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="assemble">
			<property name="builder" value="${eclipse.build.configs}/birt.wtp" />
		</ant>
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="package">
			<property name="builder" value="${eclipse.build.configs}/birt.wtp" />
		</ant>
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="postBuild">
			<property name="builder" value="${eclipse.build.configs}/birt.wtp" />
		</ant>


		<antcall target="signWTPJars" />

		<!-- unpack BIRT wtp integration feature -->

		<mkdir dir="${buildDirectory}/wtptmpsite" />
		<mkdir dir="${buildDirectory}/wtptmpsite/new" />
		<property name="wtptmpsite" value="${buildDirectory}/wtptmpsite" />

		<exec executable="unzip" dir="${buildDirectory}/${buildId}">
			<arg
				line="-o -q birt-wtp-integration-sdk-${package.version}.zip -d ${wtptmpsite}" />
		</exec>

		<unpackUpdateJars site="${wtptmpsite}/eclipse"
			output="${wtptmpsite}/new/eclipse" />

		<copy todir="${wtptmpsite}/new/eclipse" failonerror="false">
			<fileset dir="${baseLocation}/../PackageFiles/template/legal"
				includes="epl-v10.html,notice.html" />
		</copy>

		<exec executable="zip" dir="${wtptmpsite}/new">
			<arg
				line="-q ${postingDirectory}/${buildId}/birt-wtp-integration-sdk-${package.version}.zip -r eclipse" />
		</exec>
                <antcall target="logger">
                        <param name="message" value="BIRT wtp feature build finished" />
                </antcall>

	</target>

	<target name="verifyCompile">
		<!-- verify compile result -->
                <antcall target="logger">
                        <param name="message" value="Checking compile result..." />
                </antcall>
		<ant antfile="${eclipse.build.configs}/../helper.xml" target="verifyCompile" />

		<antcall target="copy2UploadArea" />

		<antcall target="renameBirtPackage" />

		<antcall target="sendNotification" />

	</target>

	<target name="copy2UploadArea" unless="HQ.BIRT.skip">
		<!--copy all packages to upload area -->
		<antcall target="logger">
			<param name="message" value="start copying to download area" />
		</antcall>
		<copy todir="${test.dir}/../../downloads/${package.version}"
			failonerror="false" overwrite="true">
			<fileset dir="${postingDirectory}/${buildId}">
				<include name="*.zip" />
				<include name="*.txt" />
				<include name="*.gz" />
				<exclude name="birt-all-${package.version}.bak.zip" />
			</fileset>
			<fileset dir="${buildDirectory}">
				<include name="directory.txt" />
			</fileset>
			<fileset file="monitor.properties" />
		</copy>
		<antcall target="logger">
			<param name="message" value="from dir: ${postingDirectory}/${buildId}" />
		</antcall>
	</target>

	<target name="buildBirtThirdPartyFeature">
		<antcall target="logger">
			<param name="message" value="Third party feature building started" />
		</antcall>

		<ant antfile="build.xml" dir="${basedir}">
			<property name="component" value="${eclipse.build.configs}/birt.third.party" />
		</ant>
		<antcall target="logger">
			<param name="message" value="Third party feature building finished" />
		</antcall>
	</target>
	<!-- - - - - - - - - - - - - - - - - - target: buildBirtRCPFeature - - - 
		- - - - - - - - - - - - - - -->
	<target name="buildBirtRCPFeature" unless="skip.build.rcp">
		<antcall target="logger">
			<param name="message" value="Export BIRT RCP product started" />
		</antcall>

		<ant antfile="buildProduct.xml" dir="${eclipse.build.configs}/birt.rcp">
			<property name="builder" value="${eclipse.build.configs}/birt.rcp" />
		</ant>

		<antcall target="logger">
			<param name="message" value="Export BIRT RCP product finished" />
		</antcall>
	</target>

	<target name="fetchBirtWtpFeature">
		<antcall target="logger">
			<param name="message" value="Fetch birt wtp integration feature started" />
		</antcall>
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="preBuild">
			<property name="builder" value="${eclipse.build.configs}/birt.wtp" />
		</ant>
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="fetch">
			<property name="builder" value="${eclipse.build.configs}/birt.wtp" />
		</ant>
		<antcall target="logger">
			<param name="message" value="Fetch birt wtp integration feature finished" />
		</antcall>
	</target>

	<target name="fetchRCP" unless="skip.build.rcp">
		<antcall target="logger">
			<param name="message" value="Fetch birt rcp plugin started" />
		</antcall>
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="preBuild">
			<property name="builder" value="${eclipse.build.configs}/birt.designer.rcp" />
		</ant>
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="fetch">
			<property name="builder" value="${eclipse.build.configs}/birt.designer.rcp" />
		</ant>
		<antcall target="logger">
			<param name="message" value="Fetch birt rcp plugin finished" />
		</antcall>
	</target>

	<target name="BuildChartViewer">
		<antcall target="logger">
			<param name="message" value="Fetch birt chart viewer started" />
		</antcall>
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="preBuild">
			<property name="builder" value="${eclipse.build.configs}/birt.chart.viewer" />
		</ant>
		<ant antfile="build.xml" dir="${eclipse.pdebuild.scripts}" target="fetch">
			<property name="builder" value="${eclipse.build.configs}/birt.chart.viewer" />
		</ant>
		<antcall target="logger">
			<param name="message" value="Fetch birt chart viewer finished" />
		</antcall>
	</target>

	<target name="buildBirtNLFeature" unless="skip.build.NL">
		<antcall target="logger">
			<param name="message" value="BIRT nl feature build started" />
		</antcall>
		<property name="NLtmpsite" value="${buildDirectory}/NLtmpsite" />
		<ant antfile="build.xml" dir="${basedir}">
			<property name="component" value="${eclipse.build.configs}/birt.nl" />
			<property name="fetchTag" value="CVS=HEAD,GIT=${mapVersionTag}" />
			<property name="forceContextQualifier" value="${buildId}" />
			<property name="generateFeatureVersionSuffix" value="false" />
		</ant>
		<antcall target="logger">
			<param name="message" value="BIRT nl feature build finished" />
		</antcall>
		<antcall target="logger">
			<param name="message" value="BIRT RCP nl feature build started" />
		</antcall>

		<ant antfile="build.xml" dir="${basedir}">
			<property name="component" value="${eclipse.build.configs}/birt.rcp.nl" />
			<property name="fetchTag" value="CVS=HEAD,GIT=${mapVersionTag}" />
			<property name="forceContextQualifier" value="${buildId}" />
			<property name="generateFeatureVersionSuffix" value="false" />
		</ant>
		<antcall target="logger">
			<param name="message" value="BIRT RCP feature build finished" />
		</antcall>

		<antcall target="logger">
			<param name="message" value="BIRT WTP nl feature build started" />
		</antcall>
		<ant antfile="build.xml" dir="${basedir}">
			<property name="component" value="${eclipse.build.configs}/birt.wtp.nl" />
			<property name="fetchTag" value="CVS=HEAD,GIT=${mapVersionTag}" />
			<property name="forceContextQualifier" value="${buildId}" />
			<property name="generateFeatureVersionSuffix" value="false" />
		</ant>
		<antcall target="logger">
			<param name="message" value="BIRT WTP feature build finished" />
		</antcall>

		<antcall target="logger">
			<param name="message" value="DTP nl feature build started" />
		</antcall>

		<ant antfile="build.xml" dir="${basedir}">
			<property name="component" value="${eclipse.build.configs}/birt.dtp.nl" />
			<property name="fetchTag" value="CVS=HEAD,GIT=${dtp.mapVersionTag}" />
			<property name="forceContextQualifier" value="${buildId}" />
			<property name="generateFeatureVersionSuffix" value="false" />
		</ant>

		<antcall target="logger">
			<param name="message" value="DTP nl feature build finished" />
		</antcall>
		<antcall target="logger">
			<param name="message" value="DTP sybase nl feature build started" />
		</antcall>

		<ant antfile="build.xml" dir="${basedir}">
			<property name="component" value="${eclipse.build.configs}/birt.dtp.sybase.nl" />
			<property name="fetchTag" value="CVS=HEAD,GIT=${dtp.mapVersionTag}" />
			<property name="forceContextQualifier" value="${buildId}" />
			<property name="generateFeatureVersionSuffix" value="false" />
		</ant>
		<antcall target="logger">
			<param name="message" value="DTP sybase nl feature build finished" />
		</antcall>

		<mkdir dir="${NLtmpsite}" />
		<mkdir dir="${NLtmpsite}/new" />
		<unzip src="${buildDirectory}/${buildId}/birt-nl-${package.version}.zip"
			dest="${NLtmpsite}" />
		<unzip
			src="${buildDirectory}/${buildId}/birt-dtp-nl-${package.version}.zip"
			dest="${NLtmpsite}" />
		<unzip
			src="${buildDirectory}/${buildId}/birt-rcp-nl-${package.version}.zip"
			dest="${NLtmpsite}" />
		<unzip
			src="${buildDirectory}/${buildId}/birt-dtp-sybase-nl-${package.version}.zip"
			dest="${NLtmpsite}" />
		<unzip
			src="${buildDirectory}/${buildId}/birt-wtp-nl-${package.version}.zip"
			dest="${NLtmpsite}" />

		<unpackUpdateJars site="${NLtmpsite}/eclipse" output="${NLtmpsite}/new/eclipse" />
		<zip destfile="${buildDirectory}/${buildId}/birt-all-nl-${package.version}.zip">
			<fileset dir="${NLtmpsite}/new/eclipse" includes="features/**" />
			<fileset dir="${NLtmpsite}/new/eclipse" includes="plugins/**" />
		</zip>
		<ant antfile="${eclipse.build.configs}/../helper.xml" target="buildLanguagePack" />
	</target>

	<target name="buildUpdateSite" if="updateSite">
		<ant antfile="${eclipse.build.configs}/../helper.xml" target="buildUpdateJars" />
	</target>

	<target name="unpackUpdateJarsForPackaging">

		<property name="tmpsite" value="${buildDirectory}/tmpsite" />

		<mkdir dir="${tmpsite}/new/eclipse/features" />
		<mkdir dir="${tmpsite}/new/eclipse/plugins" />

		<!-- BIRT framework $ OSGI package -->
		<exec executable="unzip" dir="${buildDirectory}/${buildId}">
			<arg
				line="-q birt-report-framework-sdk-${package.version}.zip -d ${tmpsite}" />
		</exec>
		<exec executable="unzip" dir="${buildDirectory}/${buildId}">
			<arg line="-o -q birt-osgi-${package.version}.zip -d ${tmpsite}" />
		</exec>
		<exec executable="unzip" dir="${buildDirectory}/${buildId}">
			<arg line="-o -q birt-chart-osgi-${package.version}.zip -d ${tmpsite}" />
		</exec>

		<!-- Create birt non-osgi runtime package -->
		<antcall target="createNonOSGiRuntime">
			<param name="outputDir" value="${tmpsite}/eclipse/plugins" />
			<param name="buildOutputDir" value="${tmpsite}/eclipse/plugins" />
			<param name="buildOutputDir.tmp" value="${tmpsite}/eclipse-runtime/plugins" />
			<param name="dtp.buildOutputDir" value="${baseLocation}/plugins" />
		</antcall>

		<!-- backup un-signed and packed version to birt-all-${package.version}.bak.zip -->
		<zip destfile="${buildDirectory}/birt-all-${package.version}.bak.zip">
			<fileset dir="${tmpsite}" includes="eclipse/**" />
			<fileset dir="${eclipse.build.configs}/../../extras"
				includes="pack.properties" />
		</zip>


		<!-- Sign packed features and plugins. Download signed features and plugins 
			back to replace ${tmpsite}/eclipse. Back signed features and plugins as update 
			site jars -->
		<antcall target="signBIRTJars" />

		<!-- zip-up non-OSGi runtime package -->
		<zip
			destfile="${postingDirectory}/${buildId}/birt-runtime-non-osgi-${package.version}.zip">
			<zipfileset dir="${tmpsite}/eclipse/plugins"
				includes="org.eclipse.datatools_*.jar,org.eclipse.birt.runtime_*.jar" />
		</zip>

		<delete failonerror="false">
			<fileset
				dir="${buildDirectory}/plugins/org.eclipse.birt.report.viewer/birt/WEB-INF/lib"
				includes="org.eclipse.datatools_*.jar,org.eclipse.birt.runtime_*.jar" />
		</delete>

		<copy
			todir="${buildDirectory}/plugins/org.eclipse.birt.report.viewer/birt/WEB-INF/lib"
			overwrite="true">
			<fileset dir="${tmpsite}/eclipse/plugins">
				<include name="org.eclipse.datatools_*.jar" />
				<include name="org.eclipse.birt.runtime_*.jar" />
			</fileset>
		</copy>

		<delete failonerror="false">
			<fileset dir="${tmpsite}/eclipse/plugins"
				includes="org.eclipse.datatools_*.jar,org.eclipse.birt.runtime_*.jar" />
		</delete>

		<!-- unpack features and plugins -->
		<unpackUpdateJars site="${tmpsite}/eclipse" output="${tmpsite}/new/eclipse" />

		<!-- zip unpacked features and plugins to birt-all-${package.version}.zip -->
		<exec executable="zip" dir="${tmpsite}/new">
			<arg
				line="-q ${buildDirectory}/birt-all-${package.version}.zip -r eclipse" />
		</exec>

		<copy todir="${postingDirectory}/${buildId}" failonerror="false">
			<fileset dir="${buildDirectory}">
				<include name="birt-all-${package.version}.bak.zip" />
			</fileset>
		</copy>

		<copy todir="${buildDirectory}/${buildId}">
			<fileset dir="${tmpsite}/new">
				<include name="eclipse/**" />
			</fileset>
		</copy>


	</target>

	<target name="signWTPJars" if="sign">

		<antcall target="SignJars">
			<param name="source.dir" value="${buildDirectory}/${buildId}" />
			<param name="source.name" value="birt-wtp-integration-sdk-${package.version}.zip" />
			<param name="target.dir" value="${buildDirectory}/${buildId}" />
			<param name="target.name"
				value="birt-wtp-integration-sdk-${package.version}.sign.zip" />
		</antcall>

		<move
			file="${buildDirectory}/${buildId}/birt-wtp-integration-sdk-${package.version}.sign.zip"
			tofile="${buildDirectory}/${buildId}/birt-wtp-integration-sdk-${package.version}.zip"
			overwrite="true" />

	</target>

	<target name="signBIRTJars" if="sign">

		<antcall target="SignJars">
			<param name="source.dir" value="${buildDirectory}" />
			<param name="source.name" value="birt-all-${package.version}.bak.zip" />
			<param name="target.dir" value="${buildDirectory}" />
			<param name="target.name" value="birt-all-${package.version}.sign.zip" />
		</antcall>

		<move file="${buildDirectory}/birt-all-${package.version}.sign.zip"
			tofile="${buildDirectory}/birt-all-${package.version}.bak.zip"
			overwrite="true" />

		<delete dir="${tmpsite}" failonerror="false" />
		<unzip src="${buildDirectory}/birt-all-${package.version}.bak.zip"
			dest="${tmpsite}" />

	</target>

	<target name="SignJars">
		<antcall target="logger">
			<param name="message"
				value="Upload ${source.name} to build.eclipse.org started" />
		</antcall>
		<scp todir="${username.sign}:${password.sign}@${hostname.sign}:${home.dir}"
			trust="true">
			<fileset dir="${source.dir}" includes="${source.name}" />
		</scp>

		<antcall target="logger">
			<param name="message" value="Upload ended. Wait for 30 mins for jarsigning..." />
		</antcall>
		<sshexec host="${hostname.sign}" username="${username.sign}"
			password="${password.sign}" trust="true"
			command="cd ${sign.dir};cp ${home.dir}/${source.name} ./;sign  ${source.name} nomail;" />
		<sleep minutes="30" />

		<antcall target="logger">
			<param name="message" value="Download signed jars started" />
		</antcall>

		<scp localtofile="${target.dir}/${target.name}" trust="true"
			file="${username.sign}:${password.sign}@${hostname.sign}:${sign.dir}/${source.name}" />

		<antcall target="logger">
			<param name="message"
				value="Download signed jars ended. Compare signed jars with unsigned" />
		</antcall>

		<condition property="CompareSignPack" value="true">
			<filesmatch file1="${source.dir}/${source.name}" file2="${target.dir}/${target.name}" />
		</condition>

		<antcall target="DownloadSignedPackAgain">
			<param name="source.name" value="${source.name}" />
			<param name="target.name" value="${target.name}" />
			<param name="target.dir" value="${target.dir}" />
		</antcall>

		<antcall target="logger">
			<param name="message" value="Packaging starts" />
		</antcall>

		<condition property="CompareSignPack2" value="true">
			<filesmatch file1="${source.dir}/${source.name}" file2="${target.dir}/${target.name}" />
		</condition>

		<ant antfile="${eclipse.build.configs}/../helper.xml" target="InformNoSign" />

	</target>

	<target name="DownloadSignedPackAgain" if="CompareSignPack">
		<antcall target="logger">
			<param name="message" value="Compare fails. Wait 10 mins to download again..." />
		</antcall>

		<sleep minutes="10" />

		<antcall target="logger">
			<param name="message" value="Download signed package started" />
		</antcall>

		<scp localtofile="${target.dir}/${target.name}" trust="true"
			file="${username.sign}:${password.sign}@${hostname.sign}:${sign.dir}/${source.name}" />

		<antcall target="logger">
			<param name="message" value="Download signed package ended" />
		</antcall>

	</target>

	<target name="integrateBirtFeatures" />


	<target name="package">
		<ant antfile="package.xml" dir="${eclipse.pdebuild.scripts}">
			<property name="packagingInfo" value="${packagingInfo}" />
			<property name="assemblyTempDir" value="${packagingInfo}/jartmp" />
		</ant>
	</target>

	<target name="buildBirtWebViewer">
		<antcall target="logger">
			<param name="message" value="Build BIRT web viewer started" />
		</antcall>

		<ant antfile="${eclipse.build.configs}/../helper.xml" target="BuildWebViewer" />

		<antcall target="logger">
			<param name="message" value="Build BIRT web viewer finished" />
		</antcall>
	</target>

	<target name="createNonOSGiRuntime">

		<path id="lib.path">
			<fileset dir="${eclipse.build.configs}/../../extras"
				includes="*.jar,lib/*.jar" />
		</path>

		<taskdef name="buildJar" classname="org.eclipse.birt.build.ant.PackTask"
			classpathref="lib.path" />

		<tstamp prefix="timestamp">
			<format property="currentTime" pattern="yyyyMMdd-HHmm" locale="en" />
		</tstamp>

		<!-- property setting -->
		<property name="buildOutputDir" value="./eclipse/plugins" />
		<property name="buildOutputDir.tmp" value="./temp" />
		<property name="outputDir" value="./eclipse/plugins" />
		<property name="BranchVersion" value="3.7.0" />
		<property name="buildId" value="v${timestamp.currentTime}" />

		<mkdir dir="${buildOutputDir.tmp}" />
		<mkdir dir="${outputDir}" />

		<copy todir="${buildOutputDir.tmp}">
			<fileset dir="${buildOutputDir}">
				<include name="org.eclipse.birt.*/**" />
				<include name="org.eclipse.datatools.*/**" />
				<include name="uk.co.spudsoft.birt.*/**" />
			</fileset>
		</copy>

		<!-- repackage org.eclipse.birt.report.engine plugin to remove 3rd party 
			jars -->

		<property file="${buildDirectory}/finalPluginsVersions.properties" />

		<unjar
			src="${buildOutputDir.tmp}/org.eclipse.birt.report.engine_${org.eclipse.birt.report.engine}.jar"
			dest="${buildOutputDir.tmp}/engine" />
		<delete
			file="${buildOutputDir.tmp}/org.eclipse.birt.report.engine_${org.eclipse.birt.report.engine}.jar" />

		<jar
			destfile="${buildOutputDir.tmp}/org.eclipse.birt.report.engine_${org.eclipse.birt.report.engine}.jar"
			basedir="${buildOutputDir.tmp}/engine" excludes="lib/*.jar"
			manifest="${buildOutputDir.tmp}/engine/META-INF/MANIFEST.MF" />
		<delete dir="${buildOutputDir.tmp}/engine" />

		<echo message="BIRT plugins location: ${buildOutputDir.tmp} " />
		<echo
			message="BIRT runtime jar output dir: ${outputDir}/org.eclipse.birt.runtime_${BranchVersion}.${buildId}.jar" />

		<buildJar basedir="${buildOutputDir.tmp}"
			output="${outputDir}/org.eclipse.birt.runtime_${BranchVersion}.${buildId}.jar">
			<bundle name="org.eclipse.birt.chart.device.extension" />
			<bundle name="org.eclipse.birt.chart.device.svg" />
			<bundle name="org.eclipse.birt.chart.engine" />
			<bundle name="org.eclipse.birt.chart.engine.extension" />
			<bundle name="org.eclipse.birt.chart.examples.core" />
			<bundle name="org.eclipse.birt.chart.reportitem" />
			<bundle name="org.eclipse.birt.core" />
			<bundle name="org.eclipse.birt.core.script.function" />
			<bundle name="org.eclipse.birt.data" />
			<bundle name="org.eclipse.birt.data.aggregation" />
			<bundle name="org.eclipse.birt.data.oda.mongodb"/>
			<bundle name="org.eclipse.birt.report.data.adapter" />
			<bundle name="org.eclipse.birt.report.data.bidi.utils" />
			<bundle name="org.eclipse.birt.report.data.oda.jdbc" />
			<bundle name="org.eclipse.birt.report.data.oda.hive" />
			<bundle name="org.eclipse.birt.report.data.oda.excel" />
			<bundle name="org.eclipse.birt.report.data.oda.sampledb" />
			<bundle name="org.eclipse.birt.report.data.oda.xml" />
			<bundle name="org.eclipse.birt.report.data.oda.jdbc.dbprofile.sampledb" />
			<bundle name="org.eclipse.birt.report.data.oda.jdbc.dbprofile" />
			<bundle name="org.eclipse.birt.report.engine" />
			<bundle name="org.eclipse.birt.report.engine.emitter.html" />
			<bundle name="org.eclipse.birt.report.engine.emitter.pdf" />
			<bundle name="org.eclipse.birt.report.engine.emitter.postscript" />
			<bundle name="org.eclipse.birt.report.engine.emitter.ppt" />
			<bundle name="org.eclipse.birt.report.engine.emitter.prototype.excel" />
			<bundle name="org.eclipse.birt.report.engine.emitter.wpml" />
			<bundle name="org.eclipse.birt.data.oda.pojo"/>
			<bundle name="org.eclipse.birt.report.engine.ooxml"/>
			<bundle name="org.eclipse.birt.report.engine.emitter.config.docx"/>
			<bundle name="org.eclipse.birt.report.engine.emitter.config.pptx"/>
			<bundle name="org.eclipse.birt.report.engine.emitter.docx"/>
			<bundle name="org.eclipse.birt.report.engine.emitter.pptx"/>
			<bundle name="org.eclipse.birt.report.engine.emitter.odp" />
			<bundle name="org.eclipse.birt.report.engine.emitter.ods" />
			<bundle name="org.eclipse.birt.report.engine.emitter.odt" />
			<bundle name="org.eclipse.birt.report.engine.odf" />
			<bundle name="org.eclipse.birt.report.engine.fonts" />
			<bundle name="org.eclipse.birt.report.engine.script.javascript" />
			<bundle name="org.eclipse.birt.report.item.crosstab.core" />
			<bundle name="org.eclipse.birt.report.model" />
			<bundle name="org.eclipse.birt.report.model.adapter.oda" />
			<bundle name="org.eclipse.birt.report.engine.dataextraction" />
			<bundle name="org.eclipse.birt.report.engine.dataextraction.csv" />
			<bundle name="org.eclipse.birt.report.engine.emitter.config" />
			<bundle name="org.eclipse.birt.report.engine.emitter.config.excel" />
			<bundle name="org.eclipse.birt.report.engine.emitter.config.html" />
			<bundle name="org.eclipse.birt.report.engine.emitter.config.pdf" />
			<bundle name="org.eclipse.birt.report.engine.emitter.config.postscript" />
			<bundle name="org.eclipse.birt.report.engine.emitter.config.ppt" />
			<bundle name="org.eclipse.birt.report.engine.emitter.config.wpml" />
			<bundle name="org.eclipse.birt.report.engine.emitter.config.odp" />
			<bundle name="org.eclipse.birt.report.engine.emitter.config.ods" />
			<bundle name="org.eclipse.birt.report.engine.emitter.config.odt" />
			<bundle name="org.eclipse.birt.axis.overlay" />
			<bundle name="uk.co.spudsoft.birt.emitters.excel" />
			<manifest>
				<attribute name="Bundle-Version" value="${BranchVersion}.${buildId}" />
				<attribute name="Bundle-Name" value="BIRT Runtime SDK" />
				<attribute name="Bundle-SymbolicName" value="org.eclipse.birt.runtime" />
				<attribute name="Bundle-Vendor" value="Eclipse.org" />
				<attribute name="Manifest-Version" value="1.0" />
			</manifest>
		</buildJar>
		<!-- exclude this jar from jar signing by adding META-INF/eclipse.inf -->
                <mkdir dir="${outputDir}/org.eclipse.birt.runtime_${BranchVersion}.${buildId}"/>
		<unzip src="${outputDir}/org.eclipse.birt.runtime_${BranchVersion}.${buildId}.jar" dest="${outputDir}/org.eclipse.birt.runtime_${BranchVersion}.${buildId}"/>
                <echo message="jarprocessor.exclude.sign=true" file="${outputDir}/org.eclipse.birt.runtime_${BranchVersion}.${buildId}/META-INF/eclipse.inf"/>
		<delete file="${outputDir}/org.eclipse.birt.runtime_${BranchVersion}.${buildId}.jar" failonerror="false"/>
                <!-- zip up the new jar --> 
                <jar destfile="${outputDir}/org.eclipse.birt.runtime_${BranchVersion}.${buildId}.jar"
  		   basedir="${outputDir}/org.eclipse.birt.runtime_${BranchVersion}.${buildId}"
                   manifest="${outputDir}/org.eclipse.birt.runtime_${BranchVersion}.${buildId}/META-INF/MANIFEST.MF"
                /> 
		<delete dir="${outputDir}/org.eclipse.birt.runtime_${BranchVersion}.${buildId}"/>

		<!-- comment out 3.7.0 release -->
		<!-- <echo message="DTP plugins location: ${dtp.buildOutputDir} "/> <buildJar 
			basedir="${dtp.buildOutputDir}" output="${outputDir}/org.eclipse.datatools_1.9.0.${buildId}.jar"> 
			<bundle name="org.eclipse.datatools.connectivity"/> <bundle name="org.eclipse.datatools.connectivity.apache.derby"/> 
			<bundle name="org.eclipse.datatools.connectivity.apache.derby.dbdefinition"/> 
			<bundle name="org.eclipse.datatools.connectivity.console.profile"/> <bundle 
			name="org.eclipse.datatools.connectivity.db.generic"/> <bundle name="org.eclipse.datatools.connectivity.dbdefinition.genericJDBC"/> 
			<bundle name="org.eclipse.datatools.connectivity.oda"/> <bundle name="org.eclipse.datatools.connectivity.oda.consumer"/> 
			<bundle name="org.eclipse.datatools.connectivity.oda.design"/> <bundle name="org.eclipse.datatools.connectivity.oda.flatfile"/> 
			<bundle name="org.eclipse.datatools.connectivity.oda.profile"/> <bundle name="org.eclipse.datatools.connectivity.sqm.core"/> 
			<bundle name="org.eclipse.datatools.enablement.hsqldb"/> <bundle name="org.eclipse.datatools.enablement.hsqldb.dbdefinition"/> 
			<bundle name="org.eclipse.datatools.enablement.ibm.db2.luw"/> <bundle name="org.eclipse.datatools.enablement.ibm.db2.luw.dbdefinition"/> 
			<bundle name="org.eclipse.datatools.enablement.ibm.informix"/> <bundle name="org.eclipse.datatools.enablement.ibm.informix.dbdefinition"/> 
			<bundle name="org.eclipse.datatools.enablement.msft.sqlserver"/> <bundle 
			name="org.eclipse.datatools.enablement.msft.sqlserver.dbdefinition"/> <bundle 
			name="org.eclipse.datatools.enablement.mysql"/> <bundle name="org.eclipse.datatools.enablement.mysql.dbdefinition"/> 
			<bundle name="org.eclipse.datatools.enablement.oda.ws"/> <bundle name="org.eclipse.datatools.enablement.oda.xml"/> 
			<bundle name="org.eclipse.datatools.enablement.oracle"/> <bundle name="org.eclipse.datatools.enablement.oracle.dbdefinition"/> 
			<bundle name="org.eclipse.datatools.enablement.postgresql"/> <bundle name="org.eclipse.datatools.modelbase.dbdefinition"/> 
			<bundle name="org.eclipse.datatools.modelbase.derby"/> <bundle name="org.eclipse.datatools.modelbase.sql"/> 
			<bundle name="org.eclipse.datatools.modelbase.sql.query"/> <manifest> <attribute 
			name="Bundle-Version" value="${BranchVersion}.${buildId}"/> <attribute name="Bundle-Name" 
			value="Data Tools Project Runtime SDK"/> <attribute name="Bundle-SymbolicName" 
			value="org.eclipse.datatools"/> <attribute name="Bundle-Vendor" value="Eclipse.org"/> 
			<attribute name="Manifest-Version" value="1.0"/> </manifest> </buildJar> -->
	</target>

	<target name="removeBirtAllForNightly" unless="sign">
		<delete failonerror="false">
			<fileset dir="${postingDirectory}/${buildId}">
				<include name="birt-all-*.zip" />
			</fileset>
		</delete>
	</target>

	<target name="generateJavaCrossReference" if="genJavaDoc">
		<ant
			antfile="${eclipse.build.configs}/../../extras/CrossReferenceGenerator.xml"
			target="generateJavaCrossReference">
		</ant>
	</target>

	<target name="generateDocumentCheck" if="genJavaDoc">
		<ant
			antfile="${eclipse.build.configs}/../../extras/CrossReferenceGenerator.xml"
			target="generateDocumentCheck">
		</ant>
	</target>

	<target name="generateJavaDoc" if="genJavaDoc">
		<ant antfile="${eclipse.build.configs}/../../extras/antJavadoc.xml" />
	</target>

	<target name="logger">
		<tstamp prefix="timestamp">
			<format property="birt" pattern="yyyy-MM-dd HH:mm:ss" locale="en" />
		</tstamp>
		<echo message="${timestamp.birt} ${message}${line.separator}"
			file="${basedir}/monitor.log" append="true" />
	</target>
</project>
